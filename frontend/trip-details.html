<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏ | CargoGo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#50C878">
</head>
<body>
    <div class="container">
        <div class="auth-topbar">
            <a href="index.html" class="logo-link">
                <h1>üöõ CargoGo</h1>
            </a>
            <button class="auth-btn" id="authBtn">
                <span id="authBtnContent">
                    <svg id="authUserIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align:middle; margin-right: 8px;">
                        <!-- –ì–æ–ª–æ–≤–∞ -->
                        <circle cx="12" cy="8" r="4" fill="#fff"/>
                        <!-- –ü–ª–µ—á–∏ -->
                        <path d="M4 20c0-3.3137 3.134-6 8-6s8 2.6863 8 6" fill="#fff"/>
                    </svg>
                    <span id="authBtnText">–í–æ–π—Ç–∏</span>
                </span>
            </button>
        </div>
        <header>
            <h1>üöó –î–µ—Ç–∞–ª–∏ –ø–æ–µ–∑–¥–∫–∏</h1>
            <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ</p>
        </header>

        <div class="card">
            <h2>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–µ–∑–¥–∫–µ</h2>
            <div class="info-list" id="tripInfoList">
                <div class="info-row">
                    <span class="info-label">–û—Ç–∫—É–¥–∞:</span>
                    <span id="tripFrom" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ö—É–¥–∞:</span>
                    <span id="tripTo" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–î–∞—Ç–∞ –ø–æ–µ–∑–¥–∫–∏:</span>
                    <span id="tripDate" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ú–∞–∫—Å. –≤–µ—Å:</span>
                    <span id="tripWeight" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞... –∫–≥</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ:</span>
                    <span id="tripReward" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞... ‚ÇΩ</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
                    <span id="tripCreatedAt" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –ø–æ–µ–∑–¥–∫–∏</h2>
            <div class="info-list" id="executorInfoList">
                <div class="info-row">
                    <span class="info-label">–ò–º—è:</span>
                    <span id="executorName" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span id="executorEmail" class="info-value">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span id="executorPhone" class="info-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Telegram:</span>
                    <span id="executorTelegram" class="info-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º</h2>
            <div style="display: flex; gap: 16px; margin-top: 16px;">
                <button id="callPhoneBtn" class="secondary-btn" style="background: #4A90E2; flex: 1;" disabled>–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
                <button id="messageTelegramBtn" class="secondary-btn" style="background: #50C878; flex: 1;" disabled>–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram</button>
            </div>
        </div>

        <footer>
            <p>CargoGo ¬© 2024 - –°–≤—è–∑—ã–≤–∞–µ–º –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π</p>
        </footer>
    </div>

    <script>
        let token = localStorage.getItem('jwtToken');

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∏—Å—Ç—ë–∫ –ª–∏ —Ç–æ–∫–µ–Ω
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = token.split('.')[1];
                const decodedPayload = atob(payload);
                const claims = JSON.parse(decodedPayload);
                const exp = claims.exp; // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
                if (!exp) return false; // –ï—Å–ª–∏ –Ω–µ—Ç exp ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–µ –∏—Å—Ç—ë–∫
                const currentTime = Math.floor(Date.now() / 1000);
                return exp < currentTime;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                return true; // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞
        function getUserNameFromToken(token) {
            if (!token) return null;
            try {
                const payload = token.split('.')[1];
                const decodedPayload = atob(payload);
                const claims = JSON.parse(decodedPayload);
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –∏–∑ –ø–æ–ª–µ–π: name, email, sub
                return claims.name || claims.unique_name || claims.email || claims.sub || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            localStorage.removeItem('jwtToken');
            token = null;
            updateAuthButton();
            window.location.href = 'index.html';
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        function updateAuthButton() {
            const btnText = document.getElementById('authBtnText');
            if (token && !isTokenExpired(token)) {
                const userName = getUserNameFromToken(token);
                btnText.textContent = userName;
            } else {
                btnText.textContent = '–í–æ–π—Ç–∏';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–∫–∏
        async function loadTripDetails() {
            if (!token || isTokenExpired(token)) {
                alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                window.location.href = 'auth.html';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–µ–∑–¥–∫–∏ –∏–∑ URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, trip-details.html?id=123)
            const urlParams = new URLSearchParams(window.location.search);
            const tripId = urlParams.get('id');

            if (!tripId) {
                alert('–ù–µ —É–∫–∞–∑–∞–Ω ID –ø–æ–µ–∑–¥–∫–∏');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch(`http://localhost:5000/api/travelers/${tripId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const trip = await response.json();
                    document.getElementById('tripFrom').textContent = trip.from || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('tripTo').textContent = trip.to || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('tripDate').textContent = new Date(trip.travelTime).toLocaleDateString() || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('tripWeight').textContent = trip.weight || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('tripReward').textContent = trip.reward || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('tripCreatedAt').textContent = new Date(trip.createdAt).toLocaleString() || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';

                    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
                    await loadExecutorDetails(trip.userId);
                } else if (response.status === 401) {
                    logout();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–∫–∏:', response);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', e);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        async function loadExecutorDetails(userId) {
            if (!token || isTokenExpired(token)) return;

            try {
                const response = await fetch(`http://localhost:5000/api/auth/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('executorName').textContent = user.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('executorEmail').textContent = user.email || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('executorPhone').textContent = user.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    document.getElementById('executorTelegram').textContent = user.telegram || '–ù–µ —É–∫–∞–∑–∞–Ω';

                    // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
                    const phone = user.phoneNumber;
                    const telegram = user.telegram;

                    if (phone) {
                        document.getElementById('callPhoneBtn').disabled = false;
                        document.getElementById('callPhoneBtn').onclick = () => {
                            window.location.href = `tel:${phone}`;
                        };
                    }

                    if (telegram) {
                        document.getElementById('messageTelegramBtn').disabled = false;
                        document.getElementById('messageTelegramBtn').onclick = () => {
                            window.open(`https://t.me/${telegram}`, '_blank');
                        };
                    }
                } else if (response.status === 401) {
                    logout();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', response);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', e);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (token && isTokenExpired(token)) {
            logout(); // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ ‚Äî —Å—Ä–∞–∑—É –≤—ã—Ö–æ–¥–∏–º
        } else {
            updateAuthButton();
            loadTripDetails(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏/–í—ã–π—Ç–∏"
        document.getElementById('authBtn').onclick = function() {
            if (token && !isTokenExpired(token)) {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
                window.location.href = 'profile.html';
            } else {
                // –ï—Å–ª–∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = 'auth.html';
            }
        };
    </script>
</body>
</html>