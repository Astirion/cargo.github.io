<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å | CargoGo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#50C878">
</head>
<body>
    <div class="container">
        <div class="auth-topbar">
             <button class="auth-btn" id="authBtn">
                <span id="authBtnContent">
                    <svg id="authUserIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" style="vertical-align:middle; margin-right: 8px;">
                        <!-- –ì–æ–ª–æ–≤–∞ -->
                        <circle cx="12" cy="8" r="4" fill="#fff"/>
                        <!-- –ü–ª–µ—á–∏ -->
                        <path d="M4 20c0-3.3137 3.134-6 8-6s8 2.6863 8 6" fill="#fff"/>
                    </svg>
                    <span id="authBtnText">–í–æ–π—Ç–∏</span>
                </span>
            </button>
        </div>
        <header>
            <h1>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
            <p>–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –ø–æ–µ–∑–¥–∫–∞–º–∏</p>
        </header>

        <div class="card">
            <h2>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">–ò–º—è</label>
                    <div id="profileName" style="padding: 8px; background: #f8f9fa; border-radius: 6px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Email</label>
                    <div id="profileEmail" style="padding: 8px; background: #f8f9fa; border-radius: 6px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <div id="profilePhone" style="padding: 8px; background: #f8f9fa; border-radius: 6px;">–ù–µ —É–∫–∞–∑–∞–Ω</div>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Telegram</label>
                    <div id="profileTelegram" style="padding: 8px; background: #f8f9fa; border-radius: 6px;">–ù–µ —É–∫–∞–∑–∞–Ω</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üöó –ú–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                <button id="myTripsBtn" class="secondary-btn" style="background: #4A90E2;">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</button>
                <button id="myShipmentsBtn" class="secondary-btn" style="background: #50C878;">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</button>
            </div>
        </div>

        <footer>
            <p>CargoGo ¬© 2024 - –°–≤—è–∑—ã–≤–∞–µ–º –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π</p>
        </footer>
    </div>

    <script>
        let token = localStorage.getItem('jwtToken');

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∏—Å—Ç—ë–∫ –ª–∏ —Ç–æ–∫–µ–Ω
        function isTokenExpired(token) {
            if (!token) return true;
            try {
                const payload = token.split('.')[1];
                const decodedPayload = atob(payload);
                const claims = JSON.parse(decodedPayload);
                const exp = claims.exp; // –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (–≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
                if (!exp) return false; // –ï—Å–ª–∏ –Ω–µ—Ç exp ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–µ –∏—Å—Ç—ë–∫
                const currentTime = Math.floor(Date.now() / 1000);
                return exp < currentTime;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                return true; // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–æ–∫–µ–Ω–∞
        function getUserNameFromToken(token) {
            if (!token) return null;
            try {
                const payload = token.split('.')[1];
                const decodedPayload = atob(payload);
                const claims = JSON.parse(decodedPayload);
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–º—è –∏–∑ –ø–æ–ª–µ–π: name, email, sub
                return claims.name || claims.unique_name || claims.email || claims.sub || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è email –∏–∑ —Ç–æ–∫–µ–Ω–∞
        function getUserEmailFromToken(token) {
            if (!token) return null;
            try {
                const payload = token.split('.')[1];
                const decodedPayload = atob(payload);
                const claims = JSON.parse(decodedPayload);
                return claims.email || null;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            localStorage.removeItem('jwtToken');
            token = null;
            updateAuthButton();
            window.location.href = 'index.html';
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        function updateAuthButton() {
            const btnText = document.getElementById('authBtnText');
            if (token && !isTokenExpired(token)) {
                const userName = getUserNameFromToken(token);
                btnText.textContent = userName;
            } else {
                btnText.textContent = '–í–æ–π—Ç–∏';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        async function loadProfile() {
            if (!token || isTokenExpired(token)) {
                alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                window.location.href = 'auth.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const profile = await response.json();
                    document.getElementById('profileName').textContent = profile.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('profileEmail').textContent = profile.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    document.getElementById('profilePhone').textContent = profile.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω';
                    document.getElementById('profileTelegram').textContent = profile.telegram || '–ù–µ —É–∫–∞–∑–∞–Ω';
                } else if (response.status === 401) {
                    logout();
                } else {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', response);
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', e);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (token && isTokenExpired(token)) {
            logout(); // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ ‚Äî —Å—Ä–∞–∑—É –≤—ã—Ö–æ–¥–∏–º
        } else {
            updateAuthButton();
            loadProfile(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–æ–π—Ç–∏/–í—ã–π—Ç–∏"
        document.getElementById('authBtn').onclick = function() {
            if (token && !isTokenExpired(token)) {
                // –í—ã—Ö–æ–¥: —É–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω
                logout();
            } else {
                window.location.href = 'auth.html';
            }
        };

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('myTripsBtn').onclick = function() {
            if (token && !isTokenExpired(token)) {
                window.location.href = 'my-trips.html'; // –∏–ª–∏ –∫—É–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ
            } else {
                alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                window.location.href = 'auth.html';
            }
        };

        document.getElementById('myShipmentsBtn').onclick = function() {
            if (token && !isTokenExpired(token)) {
                window.location.href = 'my-shipments.html'; // –∏–ª–∏ –∫—É–¥–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ
            } else {
                alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                window.location.href = 'auth.html';
            }
        };
    </script>
</body>
</html>